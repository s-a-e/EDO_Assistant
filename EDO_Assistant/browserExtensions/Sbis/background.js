(()=>{"use strict";var e={842:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.HARBuilder=void 0,t.HARBuilder=class{create(e,t){const n={log:{version:"1.2",creator:{name:"HAR Recorder",version:"1.5",comment:"Records network request and generates HAR file."},pages:[],entries:[]}};for(const[s,o]of e.entries()){const e=`page_${s+1}_${String(Math.random()).slice(2)}`,i=this.parsePage(String(e),o,t);n.log.pages.push(i.page),n.log.entries.push(...i.entries)}return n}parsePage(e,t,n){var s,o;let i=(new Date).toISOString();const r=[...Object.values(t.entries)].map((t=>this.parseEntry(e,t))).filter((e=>e));return(null===(s=null==r?void 0:r[0])||void 0===s?void 0:s.startedDateTime)&&(i=null===(o=null==r?void 0:r[0])||void 0===o?void 0:o.startedDateTime),{page:{id:e,title:n,startedDateTime:i,pageTimings:{onContentLoad:0,onLoad:0},_user:t.user},entries:r}}parseEntry(e,t){if(!t.responseParams||!t.isWebSocket&&!t.responseFinishedS&&!t.responseFailedS)return null;if(!t.isWebSocket&&!t.responseParams.response.timing)return null;const{request:n}=t.requestParams,{response:s}=t.responseParams;if(t.isWebSocket){const e=t.responseParams.response.requestHeadersText.split(" ");n.method=e[0],n.url=e[1],s.protocol=t.responseParams.response.headersText.split(" ")[0]}const o=1e3*t.requestParams.wallTime,i=new Date(o).toISOString(),r=s.protocol||"unknown",{method:a,url:c}=n,{status:d,statusText:u}=s,l=this.parseHeaders(r,n,s),h=this.getHeaderValue(s.headers,"location",""),p=this.parseQueryString(n.url),_=this.parsePostData(n,l),{time:f,timings:g}=this.computeTimings(t);let m=s.remoteIPAddress;m&&(m=m.replace(/^\[(.*)\]$/,"$1"));const v=String(s.connectionId),T=t.requestParams.initiator,{changedPriority:S}=t,N=S&&S.newPriority||n.initialPriority;let y=t.requestParams.type?t.requestParams.type.toLowerCase():void 0;const I=this.computePayload(t,l),{mimeType:C}=s,P=t.responseBodyIsBase64?"base64":void 0;let A;return t.isWebSocket&&(A=t.frames,y="websocket"),{pageref:e,startedDateTime:i,time:f,request:{method:a,url:c,httpVersion:r,cookies:[],headers:l.request.pairs,queryString:p,headersSize:l.request.size,bodySize:I.request.bodySize,postData:_},response:{status:d,statusText:u,httpVersion:r,cookies:[],headers:l.response.pairs,redirectURL:h,headersSize:l.response.size,bodySize:I.response.bodySize,_transferSize:I.response.transferSize,content:{size:t.responseLength,mimeType:t.isWebSocket?"x-unknown":C,compression:I.response.compression,text:t.responseBody,encoding:P}},cache:{},_fromDiskCache:s.fromDiskCache,timings:g,serverIPAddress:m,connection:v,_initiator:T,_priority:N,_webSocketMessages:A,_resourceType:y}}parseHeaders(e,t,n){const s=n.requestHeaders||t.headers,o=n.headers,i={request:{map:s,pairs:this.zipNameValue(s),size:-1},response:{map:o,pairs:this.zipNameValue(o),size:-1}};if(e.match(/^http\/[01].[01]$/)){const e=this.getRawRequest(t,i.request.pairs),s=this.getRawResponse(n,i.response.pairs);i.request.size=e.length,i.response.size=s.length}return i}computeTimings(e){if(e.isWebSocket){const t=0===e.frames.length?-1:this.toMilliseconds(e.frames[e.frames.length-1].time-e.requestParams.timestamp);return{time:t,timings:{blocked:-1,dns:-1,connect:-1,send:0,wait:t,receive:-1,ssl:-1}}}const t=e.responseParams.response.timing,n=e.responseFinishedS||e.responseFailedS,s=this.toMilliseconds(n-e.requestParams.timestamp),o=this.toMilliseconds(t.requestTime-e.requestParams.timestamp),i=this.firstNonNegative([t.dnsStart,t.connectStart,t.sendStart]),r=o+(-1===i?0:i);let a=-1;t.dnsStart>=0&&(a=this.firstNonNegative([t.connectStart,t.sendStart])-t.dnsStart);let c=-1;t.connectStart>=0&&(c=t.sendStart-t.connectStart);const d=t.sendEnd-t.sendStart,u=t.receiveHeadersEnd-t.sendEnd,l=this.toMilliseconds(n-(t.requestTime+t.receiveHeadersEnd/1e3));let h=-1;return t.sslStart>=0&&t.sslEnd>=0&&(h=t.sslEnd-t.sslStart),{time:s,timings:{blocked:r,dns:a,connect:c,send:d,wait:u,receive:l,ssl:h}}}computePayload(e,t){let n,s,o=e.encodedResponseLength;return-1===t.response.size?(n=-1,s=void 0):e.responseFailedS?(n=0,s=0,o=t.response.size):(n=e.encodedResponseLength-t.response.size,s=e.responseLength-n),{request:{bodySize:parseInt(this.getHeaderValue(t.request.map,"content-length",-1),10)},response:{bodySize:n,transferSize:o,compression:s}}}zipNameValue(e){const t=[];for(const[n,s]of Object.entries(e)){const e=Array.isArray(s)?s:[s];for(const s of e)t.push({name:n,value:s})}return t}parseQuery(e){var t;return null===(t=e.split("&"))||void 0===t?void 0:t.map((function(e){let t=e.split("=").map(decodeURIComponent);return{[t[0]]:t[1]}}))}getRawRequest(e,t){const{method:n,url:s,protocol:o}=e,i=[`${n} ${s} ${o}`];for(const{name:e,value:n}of t)i.push(`${e}: ${n}`);return i.push("",""),i.join("\r\n")}getRawResponse(e,t){const{status:n,statusText:s,protocol:o}=e,i=[`${o} ${n} ${s}`];for(const{name:e,value:n}of t)i.push(`${e}: ${n}`);return i.push("",""),i.join("\r\n")}getHeaderValue(e,t,n){const s=new RegExp(`^${t}$`,"i"),o=Object.keys(e).find((e=>e.match(s)));return void 0===o?n:e[o]}parseQueryString(e){const t=new URL(e);let n={};for(const e of t.searchParams.entries())n=Object.assign(Object.assign({},n),{[e[0]]:e[1]});return this.zipNameValue(n)}parsePostData(e,t){const{postData:n}=e;if(!n)return;const s=this.getHeaderValue(t.request.map,"content-type");return{mimeType:s,params:"application/x-www-form-urlencoded"===s?this.zipNameValue(this.parseQuery(n)):[],text:n}}firstNonNegative(e){const t=e.find((e=>e>=0));return void 0===t?-1:t}toMilliseconds(e){return e<0?-1:1e3*e}}},914:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.StatsBuilder=t.Stats=void 0,t.Stats=class{constructor(e,t){this._options=t,this._responseBodyCounter=0,this.url=e,this.firstRequestId=void 0,this.firstRequestMs=void 0,this.domContentEventFiredMs=void 0,this.loadEventFiredMs=void 0,this.entries=new Map,this.user=void 0}};class n{static processEvent(e,{method:t,params:s}){const o=`_${t.replace(".","_")}`,i=n[o];i&&i(e,s)}static _Page_domContentEventFired(e,t){const{timestamp:n}=t;e.domContentEventFiredMs=1e3*n}static _Page_loadEventFired(e,t){const{timestamp:n}=t;e.loadEventFiredMs=1e3*n}static _Network_requestWillBeSent(e,t){const{requestId:n,initiator:s,timestamp:o,redirectResponse:i}=t;if(!t.request.url.match("^data:")){if(e.firstRequestId||"other"!==s.type||(e.firstRequestMs=1e3*o,e.firstRequestId=n),i){const t=e.entries[n];t.responseParams={response:i},t.responseFinishedS=o,t.encodedResponseLength=i.encodedDataLength;const s=n+"_redirect_"+o;e.entries[s]=t,delete e.entries[n]}e.entries[n]={requestParams:t,responseParams:void 0,responseLength:0,encodedResponseLength:void 0,responseFinishedS:void 0,responseBody:void 0,responseBodyIsBase64:void 0,newPriority:void 0}}}static _Network_dataReceived(e,t){const{requestId:n,dataLength:s}=t,o=e.entries[n];o&&(o.responseLength+=s)}static _Network_responseReceived(e,t){const n=e.entries[t.requestId];n&&(n.responseParams=t)}static _Network_resourceChangedPriority(e,t){const{requestId:n,newPriority:s}=t,o=e.entries[n];o&&(o.newPriority=s)}static _Network_loadingFinished(e,t){const{requestId:n,timestamp:s,encodedDataLength:o}=t,i=e.entries[n];i&&(i.encodedResponseLength=o,i.responseFinishedS=s,e._responseBodyCounter++)}static _Network_loadingFailed(e,t){const{requestId:n,errorText:s,canceled:o,timestamp:i}=t,r=e.entries[n];r&&(r.responseFailedS=i)}static _Network_getResponseBody(e,t){const{requestId:n,body:s,base64Encoded:o}=t,i=e.entries[n];i&&(i.responseBody=s,i.responseBodyIsBase64=o,e._responseBodyCounter--)}static _Network_webSocketWillSendHandshakeRequest(e,t){e.entries[t.requestId]={isWebSocket:!0,frames:[],requestParams:t,responseParams:void 0,responseLength:0,encodedResponseLength:void 0,responseFinishedS:void 0,responseBody:void 0,responseBodyIsBase64:void 0,newPriority:void 0}}static _Network_webSocketHandshakeResponseReceived(e,t){n._Network_responseReceived(e,t)}static _Network_webSocketClosed(e,t){const{requestId:n,timestamp:s}=t,o=e.entries[n];o&&(o.responseFinishedS=s)}static _Network_webSocketFrameSent(e,t){const{requestId:n,timestamp:s,response:o}=t,i=e.entries[n];i&&i.frames.push({type:"send",time:s,opcode:o.opcode,data:o.payloadData})}static _Network_webSocketFrameReceived(e,t){const{requestId:n,timestamp:s,response:o}=t,i=e.entries[n];i&&i.frames.push({type:"receive",time:s,opcode:o.opcode,data:o.payloadData})}}t.StatsBuilder=n},753:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(914),i=n(842),r={},a={},c={};function d(e){chrome.runtime.lastError&&alert(chrome.runtime.lastError.message)}chrome.runtime.onMessage.addListener(((e,t,n)=>{const{action:u,tab:l}=e;if("TOGGLE_RECORD"===u)return function(e,t){s(this,void 0,void 0,(function*(){let n=(yield chrome.storage.local.get(["tabs"])).tabs;const u=e.id;if(null==n?void 0:n[u]){chrome.debugger.onEvent.removeListener(a[u]),chrome.debugger.detach({tabId:u});try{const n=new URL(e.url).host,s=`${n}_${function(){const e=new Date;return`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}_${e.getHours()}-${e.getMinutes()}-${e.getSeconds()}`}()}.har`;c[u]={fileName:s,fileContent:JSON.stringify((new i.HARBuilder).create([r[u]],n)),uploadProgress:0},t({action:"RECORD_FINISHED",data:{fileName:s}})}catch(e){console.log(e)}delete n[u],delete r[u],yield chrome.storage.local.set({tabs:n}),console.log(`Remote debugging: Tab ${u} now unregistered.`)}else{n||(n={});const e=new o.Stats;r[u]=e,n[u]=!0,delete c[u],chrome.storage.local.set({tabs:n}),chrome.debugger.attach({tabId:u},"1.0",d.bind(null,u)),chrome.debugger.sendCommand({tabId:u},"Network.enable"),a[u]=(t,n,i)=>s(this,void 0,void 0,(function*(){if(o.StatsBuilder.processEvent(e,{method:n,params:i}),r[u]=e,"Network.loadingFinished"===n){let t;try{t=yield chrome.debugger.sendCommand({tabId:u},"Network.getResponseBody",{requestId:i.requestId})}catch(e){t=null}if(t){const{body:n,base64Encoded:s}=t;o.StatsBuilder.processEvent(e,{method:"Network.getResponseBody",params:{requestId:i.requestId,body:n,base64Encoded:s}})}}})),chrome.debugger.onEvent.addListener(a[u]),chrome.debugger.onDetach.addListener((({tabId:e})=>s(this,void 0,void 0,(function*(){delete c[e],delete r[e];const t=(yield chrome.storage.local.get(["tabs"])).tabs;delete t[e],chrome.storage.local.set({tabs:t}),chrome.runtime.sendMessage({action:"RECORD_CANCELED"})})))),t({action:"RECORD_STARTED"})}}))}(l,n),!0;if("GET_HAR"===u){const e=l.id;return n({action:"HAR_RECEIVED",data:c[e]}),!0}})),chrome.runtime.onMessageExternal.addListener((e=>{const{action:t,tab:n}=e;if("SET_UPLOAD_PROGRESS"===t){const{progress:t,uploadNumber:s}=e.payload;!function(e,t,n){e in c&&(t>(c[e].uploadProgress||0)&&(c[e].uploadProgress=t),n&&(c[e].uploadNumber=n))}(n.id,t,s)}}))},82:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(295),i=n(466),r=n(496),a=n(109),c=n(772),d=n(420),u=n(485),l=n(319),h=n(96),p=n(225);t.default=class{constructor(e,t,n,s){this._pageTransportManager=e,this._serviceQueryManager=t,this._browserExtensionSupport=n,this._pageActions={[p.ACTION.RUN_DOWNLOADED_FILE]:new o.default,[p.ACTION.SHOW_DOWNLOADED_FILE]:new i.default,[p.ACTION.SET_FOREGROUND_WINDOW]:new u.default(this._pageTransportManager),[p.ACTION.OPEN_NEW_TAB]:new l.default(this._pageTransportManager),[p.ACTION.START_TRACKING]:new a.default(this._pageTransportManager,s),[p.ACTION.STOP_TRACKING]:new c.default,[p.ACTION.GET_LAST_TRACKING_RESULT]:new d.default(this._pageTransportManager),[p.ACTION.ADD_BOOKMARK]:new h.default},this._pluginActions={[p.PLUGIN_ACTION.OPEN_NOTICE]:new r.default(this._pageTransportManager,this._serviceQueryManager,this._browserExtensionSupport)}}isPageAction(e){return e===p.EXTENSION_ACTION_CMD}processPageAction(e){return s(this,void 0,void 0,(function*(){const t=JSON.parse(e.data),n={actionGuid:t.actionGuid,portId:e.tab_id,senderId:e.senderId};return t.type in this._pageActions?this._pageActions[t.type].execute(t.payload,n):{status:p.ACTION_STATUS.FAIL,actionGuid:t.actionGuid}}))}processPluginAction(e){return s(this,void 0,void 0,(function*(){try{const t=JSON.parse(e.data);"event"===t.type&&"browser-extension.open-link"===t.data.eventName&&this._pluginActions[p.PLUGIN_ACTION.OPEN_NOTICE].execute({notice:t.data.data.Notice,url:t.data.data.Url,eventId:t.data.data.EventId})}catch(e){return}}))}}},96:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(715);t.default=class{execute(e){return s(this,void 0,void 0,(function*(){if(!e.url&&!e.title)return;const t=(0,o.getApiObject)(),n={permissions:["bookmarks"]};try{(yield t.permissions.request(n))&&t.bookmarks.create({parentId:"1",url:e.url,title:e.title})}catch(n){t.bookmarks.create({parentId:"toolbar_____",url:e.url,title:e.title})}}))}}},225:(e,t)=>{var n,s,o,i;Object.defineProperty(t,"__esModule",{value:!0}),t.NOTICE_ID=t.EXTENSION_ACTION_CMD=t.COMMAND_TYPE=t.PLUGIN_ACTION=t.ACTION=t.APP_LIST=t.APP_CHECK_STATUS=t.ACTION_STATUS=void 0,(i=t.ACTION_STATUS||(t.ACTION_STATUS={}))[i.SUCCESS=0]="SUCCESS",i[i.PROGRESS=1]="PROGRESS",i[i.FAIL=2]="FAIL",(o=t.APP_CHECK_STATUS||(t.APP_CHECK_STATUS={})).SUCCESS="success",o.UNKNOWN="unknown",o.FAIL="failure",(s=t.APP_LIST||(t.APP_LIST={})).SabyPlugin="SabyPlugin",s.SabyAdmin="SabyAdmin",s.SabyCam="SabyCam",s.SabyScreen="SabyScreen",(n=t.ACTION||(t.ACTION={})).RUN_DOWNLOADED_FILE="RUN_DOWNLOADED_FILE",n.SHOW_DOWNLOADED_FILE="SHOW_DOWNLOADED_FILE",n.SET_FOREGROUND_WINDOW="SET_FOREGROUND_WINDOW",n.OPEN_NEW_TAB="OPEN_NEW_TAB",n.START_TRACKING="START_TRACKING",n.STOP_TRACKING="STOP_TRACKING",n.GET_LAST_TRACKING_RESULT="GET_LAST_TRACKING_RESULT",n.ADD_BOOKMARK="ADD_BOOKMARK",(t.PLUGIN_ACTION||(t.PLUGIN_ACTION={})).OPEN_NOTICE="OPEN_NOTICE",(t.COMMAND_TYPE||(t.COMMAND_TYPE={})).OPEN_NOTICE="OPEN_NOTICE",t.EXTENSION_ACTION_CMD="extension_action",t.NOTICE_ID="saby_plugin_notice"},420:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(322),i=n(109);t.default=class{constructor(e){this._pageTransport=e}execute(e,t){return s(this,void 0,void 0,(function*(){const n=i.default.getLastResult(e.appName),s={appName:e.appName,result:n};this._pageTransport.sendToTab({id:o.BROADCAST_TAB_ID,tab_id:t.portId,cmd:"last_check_result",data:JSON.stringify(s)},t.senderId)}))}}},319:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(715);t.default=class{constructor(e){this._pageTransport=e}execute(e,t){return s(this,void 0,void 0,(function*(){if(t&&"portId"in t){const n=yield this._pageTransport.getWindowIdByPort(t.portId);n&&(0,o.openNewTab)(e.url,n)}}))}}},496:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(715),i=n(225),r=n(715),a=n(589),c=n(322);t.default=class{constructor(e,t,n){this._pageTransport=e,this._serviceQueryManager=t,this._browserExtensionSupport=n}execute(e){return s(this,void 0,void 0,(function*(){const t=(0,o.getApiObject)(),{notice:n,url:s,eventId:d}=e;try{const e=yield t.windows.getLastFocused();if(!(null==e?void 0:e.id))return;const o=(yield t.tabs.query({active:!0,windowId:e.id}))[0];if(o&&o.url){if(!(yield this._browserExtensionSupport.setEventComplete(d,o.title)))return;const e=new a.default(this._serviceQueryManager),s=yield e.isTrustedDomain(o.url);if(e.destroy(),s){const e={type:i.COMMAND_TYPE.OPEN_NOTICE,data:n};if(this._pageTransport.sendToTab({id:c.BROADCAST_TAB_ID,tab_id:o.id,cmd:"extension_command",data:JSON.stringify(e)},o.id))return void t.windows.update(o.windowId,{focused:!0})}}(0,r.openNewTab)(s,e.id)}catch(e){}}))}}},295:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(949),i=n(715),r=n(225);let a;t.default=class{execute(e,t){return s(this,void 0,void 0,(function*(){const n=(0,i.getApiObject)(),s=(null==e?void 0:e.lang)||o.UI_LANG.RU,c=(null==t?void 0:t.actionGuid)||"",d=yield(0,i.getDownloadItems)({filenameRegex:e.filename,orderBy:["-startTime"],exists:!0,state:"complete",startedAfter:e.timeStamp});if(d.length>0){const e=d.shift(),t=e.id,i=e.filename.replace(/\\/g,"/").split("/").pop(),u={type:"basic",iconUrl:n.runtime.getURL("sbisPlugin-logo-48.png"),priority:2,title:(0,o.getLocalizedString)("СБИС Плагин",s),message:(0,o.getLocalizedString)("Пожалуйста, нажмите на уведомление, чтобы запустить установку",s),buttons:[{title:(0,o.getLocalizedString)("Установить",s)}],requireInteraction:!0};return new Promise((e=>{const s=o=>{o===r.NOTICE_ID&&(n.downloads.open(t),n.notifications.onClicked.removeListener(s),n.notifications.onButtonClicked.removeListener(s),a=null,e({status:r.ACTION_STATUS.SUCCESS,actionGuid:c,data:{filename:i,downloadId:t}}),n.notifications.clear(r.NOTICE_ID))};a&&(n.notifications.onClicked.removeListener(a),n.notifications.onButtonClicked.removeListener(a)),n.notifications.clear(r.NOTICE_ID,(()=>{n.notifications.create(r.NOTICE_ID,u,(()=>{n.notifications.onClicked.addListener(s),chrome.notifications.onButtonClicked.addListener(s),a=s,e({status:r.ACTION_STATUS.PROGRESS,actionGuid:c,data:{filename:i,downloadId:t}})}))}))}))}return{status:r.ACTION_STATUS.FAIL,actionGuid:c}}))}}},485:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(715);t.default=class{constructor(e){this._pageTransport=e}execute(e,t){return s(this,void 0,void 0,(function*(){if(!(null==t?void 0:t.portId))return;const e=(0,o.getApiObject)(),n=yield this._pageTransport.getWindowIdByPort(t.portId);n&&e.windows.update(n,{focused:!0})}))}}},466:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(715),i=n(225),r=n(949);t.default=class{execute(e,t){return s(this,void 0,void 0,(function*(){const n=(0,o.getApiObject)(),s=(null==e?void 0:e.lang)||r.UI_LANG.RU,a=(null==t?void 0:t.actionGuid)||"";if(e.downloadId)return n.downloads.show(e.downloadId),{status:i.ACTION_STATUS.SUCCESS,actionGuid:a};const c=yield(0,o.getDownloadItems)({filenameRegex:e.filename,orderBy:["-startTime"],exists:!0,startedAfter:e.timeStamp});if(c.length>0){const e=c.shift(),t=e.id,o=e.filename.replace(/\\/g,"/").split("/").pop(),d={type:"basic",iconUrl:n.runtime.getURL("sbisPlugin-logo-48.png"),priority:2,title:(0,r.getLocalizedString)("СБИС Плагин",s),message:(0,r.getLocalizedString)("Пожалуйста, запустите файл $filename$ в появившемся окне",s).replace("$filename$",o)};return n.notifications.clear(i.NOTICE_ID,(()=>{n.notifications.create(i.NOTICE_ID,d,(()=>{n.downloads.show(t)}))})),{status:i.ACTION_STATUS.SUCCESS,actionGuid:a,data:{filename:o,downloadId:t}}}return{status:i.ACTION_STATUS.FAIL,actionGuid:a}}))}}},109:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(601),i=n(322),r=n(225);class a{constructor(e,t){this._pinger=t,this._pageTransport=e,a._setStartResultValues()}execute(e,t){return s(this,void 0,void 0,(function*(){a._isExistTrackedApps()?this._setPage(e.appName,t.senderId):(this._setPage(e.appName,t.senderId),this._checkAppConnections())}))}_checkAppConnections(){return s(this,void 0,void 0,(function*(){if(!a._isExistTrackedApps())return;const e=Array.from(a.trackingPages.keys()),t=yield this._pinger.connectApplications(e);if(a._setLastResults(t),t.map((e=>e.value)).includes(!0)){const e=t.filter((e=>e.value)).map((e=>e.appName));this._notifyTrackingPages(e),this._deleteApp(e)}return this._checkAppConnections()}))}_deleteApp(e){e.forEach((e=>{if(a.trackingPages.has(e)){const t=a.trackingPages.get(e);o.default.log(`Tracking a connection to ${e} was stopped for ${null==t?void 0:t.join(", ")}`),a.trackingPages.delete(e)}}))}_setPage(e,t){const n=a.trackingPages.get(e)||[];n.indexOf(t)<0&&(o.default.log(`Start tracking a connection to ${e} from ${t}`),n.push(t),a.trackingPages.set(e,n))}_notifyTrackingPages(e){e.forEach((e=>{const t=a.trackingPages.get(e);null==t||t.forEach((t=>{this._pageTransport.sendToTab({id:i.BROADCAST_TAB_ID,tab_id:t,cmd:"application_launched",data:JSON.stringify({appName:e})},t)}))}))}static stopTracking(e,t){if(a.trackingPages.has(e)){o.default.log(`Tracking a connection to ${e} from ${t} was stopped`);const n=a.trackingPages.get(e),s=n.indexOf(t);n.splice(s,1),n.length>0?a.trackingPages.set(e,n):a.trackingPages.delete(e)}}static getLastResult(e){const t=a.lastCheck.get(e);return o.default.log(`Getting the latest results about ${e}: ${a.lastCheck.get(e)}`),t}static removePort(e){a.trackingPages.forEach(((t,n,s)=>{var i;const r=t.indexOf(e);r>-1&&(o.default.log(`Destroy of tracking page ${e} for ${n}`),t.splice(r,1)),0===(null===(i=s.get(n))||void 0===i?void 0:i.length)&&s.delete(n)}))}static _setStartResultValues(){a.lastCheck.set(r.APP_LIST.SabyAdmin,r.APP_CHECK_STATUS.UNKNOWN),a.lastCheck.set(r.APP_LIST.SabyPlugin,r.APP_CHECK_STATUS.UNKNOWN),a.lastCheck.set(r.APP_LIST.SabyScreen,r.APP_CHECK_STATUS.UNKNOWN),a.lastCheck.set(r.APP_LIST.SabyCam,r.APP_CHECK_STATUS.UNKNOWN)}static _setLastResults(e){e.forEach((e=>{const t=e.value?r.APP_CHECK_STATUS.SUCCESS:r.APP_CHECK_STATUS.FAIL;a.lastCheck.set(e.appName,t)}))}static _isExistTrackedApps(){return 0!==a.trackingPages.size}}t.default=a,a.trackingPages=new Map,a.lastCheck=new Map},772:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(109);t.default=class{execute(e,t){return s(this,void 0,void 0,(function*(){o.default.stopTracking(e.appName,t.senderId)}))}}},715:function(e,t){var n=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};let s;Object.defineProperty(t,"__esModule",{value:!0}),t.getGuid=t.openNewTab=t.getDownloadItems=t.setApiObject=t.getApiObject=void 0,t.getApiObject=function(){return s},t.setApiObject=function(e){s=e},t.getDownloadItems=function(e){return n(this,void 0,void 0,(function*(){return e.urlRegex="https://.*update.*.sbis.ru/.+",yield s.downloads.search(e)}))},t.openNewTab=function(e,t){s.tabs.create({url:e,windowId:t}),s.windows.update(t,{focused:!0})},t.getGuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}},439:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(601),i=n(194),r=n(322),a=n(238);class c{constructor(e,t,n=0,s=0){this.type=e,this.site=t,this.timeFrom=n,this.timeTo=s}}t.default=class{constructor(e){this.urlCache=[],this.urlToSend=[],this.connId=r.AM_CONNECTION_ID_INITIAL,this.port=8201,this.needConnect=!0,this.sendIntervalId=null,this._isConnectionAlive=!1,this.isChromeExtension=e,this.onUpdatedListener=this.onUpdatedListener.bind(this),this.onActivatedListener=this.onActivatedListener.bind(this),this.onFocusChangedListener=this.onFocusChangedListener.bind(this),e?chrome.runtime.getPlatformInfo((e=>{e.os.search("linux")>-1&&this.start()})):-1!==window.navigator.platform.search("Linux")&&this.start()}setConnectionStatus(e){this._isConnectionAlive=e,e||this.connId--}setServiceQueryManager(e){this._amService=new a.default(e)}start(){o.default.logStore("Запуск ActivityMonitor"),chrome.tabs.onUpdated.addListener(this.onUpdatedListener),chrome.tabs.onActivated.addListener(this.onActivatedListener),chrome.windows.onFocusChanged.Filters=["normal","devtools"],chrome.windows.onFocusChanged.addListener(this.onFocusChangedListener),this.sendIntervalId=setInterval((()=>this.sendUrls()),3e5)}stop(){o.default.logStore("Остановка ActivityMonitor"),chrome.tabs.onUpdated.removeListener(this.onUpdatedListener),chrome.tabs.onActivated.removeListener(this.onActivatedListener),chrome.windows.onFocusChanged.removeListener(this.onFocusChangedListener),this.sendIntervalId&&clearInterval(this.sendIntervalId)}onURLChanged(e){const t=Math.floor(Date.now()/1e3),n=this._siteFromUrl(e);if(this.urlCache.length){const e=this.urlCache[this.urlCache.length-1];if(e.timeTo=t,e.site===n.site)return}n.timeFrom=t,this.urlCache.push(n),o.default.info(n.site)}sendUrls(){var e;return s(this,void 0,void 0,(function*(){if(this.urlCache.length){const e=Math.floor(Date.now()/1e3),t=this.urlCache[this.urlCache.length-1];t.timeTo=e,this.urlToSend=this.urlToSend.concat(this.urlCache.filter((e=>e.timeFrom<e.timeTo))),this.urlCache=[new c(t.type,t.site,e,e)]}this._isConnectionAlive&&this.urlToSend.length>0&&(o.default.logStore(`Отправка ${this.urlToSend.length} записей`),null===(e=this._amService)||void 0===e||e.callMethod({moduleName:"ActivityMonitor",query:JSON.stringify({jsonrpc:"2.0",protocol:5,method:"ActivityMonitor.UrlFromExtension",params:{browser:this.isChromeExtension?"chrome":"firefox",urls:this._urlsToRecordSetTimestamp()},id:this.connId})}).then((e=>{null===e&&(o.default.logStore("успешная отправка"),this.urlToSend=[])})).catch((e=>{if("RPC_ERROR"===e.errorType){const t=e.error;o.default.logStore("RPC_ERROR "+JSON.stringify(t))}})))}))}_urlsToRecordSetTimestamp(){return{s:[{n:"Type",t:"Число целое"},{n:"Name",t:"Строка"},{n:"Description",t:"Строка"},{n:"Begin",t:"Число целое"},{n:"End",t:"Число целое"}],f:0,d:this.urlToSend.map((e=>[e.type,e.site,"",e.timeFrom,e.timeTo])),_type:"recordset"}}onUpdatedListener(e,t,n){"loading"===t.status&&n.active&&(this.onURLChanged(n.url),this.isChromeExtension&&"chrome://extensions/SbisPluginExtension/save_logs"===n.url&&o.default.logsLoaded.then((()=>{var e,t;e=`SBISPluginExtension_${chrome.runtime.getManifest().version}_logs.txt`,t=JSON.stringify(o.default.logs),chrome.downloads.download({filename:e,saveAs:!0,url:`data:text/plain,${t}`})})))}onActivatedListener(e){e.tabId!==chrome.tabs.TAB_ID_NONE&&chrome.tabs.get(e.tabId,(e=>{this.onURLChanged(e.url)}))}onFocusChangedListener(e){if(e===chrome.windows.WINDOW_ID_NONE){const e={populate:!1};this.isChromeExtension&&(e.windowTypes=["normal","devtools"]),chrome.windows.getCurrent(e,(e=>{"devtools"===e.type&&this.onURLChanged("devtools")}))}else chrome.tabs.query({active:!0,windowId:e},(e=>{var t;this.onURLChanged(null===(t=e[0])||void 0===t?void 0:t.url)}))}_siteFromUrl(e){if(this.isChromeExtension){if(!e||"devtools"===e)return new c(0,"Инструмент разработчика в браузере")}else if(!e)return new c(0,"firefox");const t=new URL(e);return this.isChromeExtension||"about:"!==t.protocol||"devtools-toolbox"!==t.pathname?"file:"===t.protocol?new c(0,"Просмотр файлов в браузере"):"http:"!==t.protocol&&"https:"!==t.protocol?new c(0,this.isChromeExtension?"chrome":"firefox"):new c(1,i.default.toUnicode(t.hostname)):new c(0,"Инструмент разработчика в браузере")}}},481:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.start=void 0;const o=n(601),i=n(674),r=n(82),a=n(754),c=n(818),d=n(923),u=n(109),l=n(427),h=n(322),p="ALARM_LOADING";("undefined"==typeof window?self:window).SPDebug=e=>{o.default.debugMode=e},t.start=function(e,t,n){const o=new l.default(n),u=new i.default(n),_=new a.default(n),f=new c.default(_),g=new d.default(f),m=new r.default(t,f,g,u);e.setServiceQueryManager(f),chrome.alarms.create(p,{delayInMinutes:.05}),n.onMessage=e=>{if(o.clearReconnectNmhTimeout(),u.isPingMessage(e))u.parsePingMessage(e);else if(_.isServiceMessage(e)){if(_.parseMessage(e))return;if(f.parseMessage(e))return;m.processPluginAction(e)}else t.sendMessage(e)},n.onBroadcast=e=>{t.broadcastMessage(e)},t.onQuery=e=>s(this,void 0,void 0,(function*(){m.isPageAction(e.cmd)?m.processPageAction(e).then((n=>{n&&t.sendMessage({id:e.id,tab_id:e.tab_id,cmd:"extension_action_result",data:JSON.stringify(n)})})):("connect"===e.cmd&&"nng"===e.data&&o.createReconnectNmhTimeout(),n.sendMessageToNmh(e))}));const v=()=>{m.processPageAction({cmd:"extension_action",senderId:h.TRACKING_ID,tab_id:h.TRACKING_ID,data:JSON.stringify({payload:{appName:"SabyPlugin"},type:"START_TRACKING"}),id:h.TRACKING_ID})};u.onDisconnect=()=>{v(),e.setConnectionStatus(!1)},u.onConnect=n=>{t.sendToAllTabs(n),_.reconnect(),g.reload(),g.registerExtension(),e.setConnectionStatus(!0)},chrome.alarms.onAlarm.addListener((e=>{e.name===p&&(t.sendToAllTabs({tab_id:h.BROADCAST_TAB_ID,id:h.EXTENSION_LOADED_ID,cmd:"extension_loaded",data:""}),v())}))},chrome.runtime.onStartup.addListener((()=>{o.default.deleteOldLogs().then((()=>{o.default.logStore("startup")}))})),chrome.tabs.onRemoved.addListener((e=>{u.default.removePort(e)}))},322:(e,t)=>{var n;Object.defineProperty(t,"__esModule",{value:!0}),t.APP_ID=t.AM_CONNECTION_ID_INITIAL=t.APP_CONNECTION_ID=t.SERVICE_CONNECTION_ID=t.EXTENSION_LOADED_ID=t.TRACKING_ID=t.BROADCAST_TAB_ID=void 0,t.BROADCAST_TAB_ID=-1,t.TRACKING_ID=-111,t.EXTENSION_LOADED_ID=-30,t.SERVICE_CONNECTION_ID=-40,t.APP_CONNECTION_ID=-41,t.AM_CONNECTION_ID_INITIAL=-120,(n=t.APP_ID||(t.APP_ID={}))[n.SabyPlugin=101]="SabyPlugin",n[n.SabyAdmin=102]="SabyAdmin",n[n.SabyScreen=103]="SabyScreen",n[n.SabyCam=104]="SabyCam"},194:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});const n=function(){const e={};e.utf16={decode:function(e){for(var t,n,s=[],o=0,i=e.length;o<i;){if(55296==(63488&(t=e.charCodeAt(o++)))){if(n=e.charCodeAt(o++),55296!=(64512&t)||56320!=(64512&n))throw new RangeError("UTF-16(decode): Illegal UTF-16 sequence");t=((1023&t)<<10)+(1023&n)+65536}s.push(t)}return s},encode:function(e){for(var t,n=[],s=0,o=e.length;s<o;){if(55296==(63488&(t=e[s++])))throw new RangeError("UTF-16(encode): Illegal UTF-16 value");t>65535&&(t-=65536,n.push(String.fromCharCode(t>>>10&1023|55296)),t=56320|1023&t),n.push(String.fromCharCode(t))}return n.join("")}};var t=36,s=2147483647;function o(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function i(e,n,s){var o;for(e=s?Math.floor(e/700):e>>1,e+=Math.floor(e/n),o=0;e>455;o+=t)e=Math.floor(e/35);return Math.floor(o+36*e/(e+38))}return e.decode=function(n,o){var r,a,c,d,u,l,h,p,_,f,g,m,v,T,S=[],N=[],y=n.length;for(r=128,c=0,d=72,(u=n.lastIndexOf("-"))<0&&(u=0),l=0;l<u;++l){if(o&&(N[S.length]=n.charCodeAt(l)-65<26),n.charCodeAt(l)>=128)throw new RangeError("Illegal input >= 0x80");S.push(n.charCodeAt(l))}for(h=u>0?u+1:0;h<y;){for(p=c,_=1,f=t;;f+=t){if(h>=y)throw RangeError("punycode_bad_input(1)");if((g=(T=n.charCodeAt(h++))-48<10?T-22:T-65<26?T-65:T-97<26?T-97:t)>=t)throw RangeError("punycode_bad_input(2)");if(g>Math.floor((s-c)/_))throw RangeError("punycode_overflow(1)");if(c+=g*_,g<(m=f<=d?1:f>=d+26?26:f-d))break;if(_>Math.floor(s/(t-m)))throw RangeError("punycode_overflow(2)");_*=t-m}if(d=i(c-p,a=S.length+1,0===p),Math.floor(c/a)>s-r)throw RangeError("punycode_overflow(3)");r+=Math.floor(c/a),c%=a,o&&N.splice(c,0,n.charCodeAt(h-1)-65<26),S.splice(c,0,r),c++}if(o)for(c=0,v=S.length;c<v;c++)N[c]&&(S[c]=String.fromCharCode(S[c]).toUpperCase().charCodeAt(0));return e.utf16.encode(S)},e.encode=function(n,r){var a,c,d,u,l,h,p,_,f,g,m,v;r&&(v=e.utf16.decode(n));var T=(n=e.utf16.decode(n.toLowerCase())).length;if(r)for(h=0;h<T;h++)v[h]=n[h]!=v[h];var S,N=[];for(a=128,c=0,l=72,h=0;h<T;++h)n[h]<128&&N.push(String.fromCharCode(v?(S=n[h],(S-=(S-97<26)<<5)+((!v[h]&&S-65<26)<<5)):n[h]));for(d=u=N.length,u>0&&N.push("-");d<T;){for(p=s,h=0;h<T;++h)(m=n[h])>=a&&m<p&&(p=m);if(p-a>Math.floor((s-c)/(d+1)))throw RangeError("punycode_overflow (1)");for(c+=(p-a)*(d+1),a=p,h=0;h<T;++h){if((m=n[h])<a&&++c>s)return Error("punycode_overflow(2)");if(m==a){for(_=c,f=t;!(_<(g=f<=l?1:f>=l+26?26:f-l));f+=t)N.push(String.fromCharCode(o(g+(_-g)%(t-g),0))),_=Math.floor((_-g)/(t-g));N.push(String.fromCharCode(o(_,r&&v[h]?1:0))),l=i(c,d+1,d==u),c=0,++d}}++c,++a}return N.join("")},e.toASCII=function(e){for(var t=e.split("."),s=[],o=0;o<t.length;++o){var i=t[o];s.push(i.match(/[^A-Za-z0-9-]/)?"xn--"+n.encode(i):i)}return s.join(".")},e.toUnicode=function(e){for(var t=e.split("."),s=[],o=0;o<t.length;++o){var i=t[o];s.push(i.match(/^xn--/)?n.decode(i.slice(4)):i)}return s.join(".")},e}();t.default=n},923:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(238);class i extends o.default{registerExtension(){var e;return s(this,void 0,void 0,(function*(){let t="";if(null===(e=null===navigator||void 0===navigator?void 0:navigator.userAgentData)||void 0===e?void 0:e.getHighEntropyValues){const e=(yield navigator.userAgentData.getHighEntropyValues(["fullVersionList"])).fullVersionList.find((({brand:e})=>"Google Chrome"===e));e&&(t=e.version)}const n={UserAgent:navigator.userAgent,Version:t};return this.callMethod({moduleName:"BrowserExtensionSupport",query:`{"jsonrpc":"2.0","protocol":6,"method":"BrowserExtensionSupport.RegisterExtension","params":${JSON.stringify(n)},"id":1}`})}))}setEventComplete(e,t){return this.callMethod({moduleName:"BrowserExtensionSupport",query:`{"jsonrpc":"2.0","protocol":6,"method":"BrowserExtensionSupport.SetEventComplete","params":{"EventId": "${e}","TabHeader": "${t}"},"id":1}`})}}t.default=i},238:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=n(715);t.default=class{constructor(e){this._guid="",this._serviceQueryManager=e,this.reload()}callMethod(e){return this._serviceQueryManager.sendQuery(Object.assign({serviceGuid:this._guid,protoVersion:1,queryId:(0,s.getGuid)(),moduleVersion:"0"},e))}reload(){this._guid=(0,s.getGuid)()}destroy(){this._serviceQueryManager.sendQuery({serviceGuid:this._guid,protoVersion:1,queryId:(0,s.getGuid)(),moduleName:"CoreService",moduleVersion:"0",query:`{"jsonrpc":"2.0","protocol":6,"method":"BaseExtension.destroy","params":{"serviceGuid":"${this._guid}"},"id":1}`})}}},589:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=n(238);class o extends s.default{isTrustedDomain(e){return this.callMethod({moduleName:"CoreService",query:`{"jsonrpc":"2.0","protocol":6,"method":"ServiceInfoProvider.IsTrustedDomain","params":{"Url":"${e}"},"id":1}`})}}t.default=o},377:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CONNECTION_STATE=void 0;const s=n(601),o=n(322);var i;!function(e){e[e.UNKNOWN=-1]="UNKNOWN",e[e.OPEN=0]="OPEN",e[e.CLOSED=1]="CLOSED"}(i=t.CONNECTION_STATE||(t.CONNECTION_STATE={}));const r=e=>{};t.default=class{constructor(){this.connectionState=i.UNKNOWN,this.onDisconnect=null,this.onMessage=r,this.onBroadcast=r,this.queries={},this._port=null,this._receiveMessageFromNmh=this._receiveMessageFromNmh.bind(this)}connectToNmh(e){if(this._port)e&&e();else{try{this._port=chrome.runtime.connectNative("ru.tensor.sbis_plugin_nmh")}catch(e){return s.default.error("Native Messaging Host connection fail ("+e.name+") : "+e.message),void(this.onDisconnect&&this.onDisconnect())}s.default.log("Native Messaging Host connection successful"),this.connectionState=i.OPEN,e&&e(),this._port.onMessage.addListener(this._receiveMessageFromNmh),this._port.onDisconnect.addListener((()=>{var e;this.connectionState=i.CLOSED,s.default.log("Native Messaging Host disconnected outside"),this._port=null,this.onBroadcast({id:o.BROADCAST_TAB_ID,cmd:"error",data:"Native Messaging Host is crashed"}),"Native host has exited."===(null===(e=chrome.runtime.lastError)||void 0===e?void 0:e.message)&&this.connectToNmh(),this.onDisconnect&&this.onDisconnect()}))}}sendMessageToNmh(e){if(!this._port)return this.connectToNmh(),void this.onMessage({tab_id:e.tab_id,id:e.id,cmd:"error",data:"Send message to NMH fail. NMHPort is unavailable"});e.type="FROM_BACKGROUND_SCRIPT_TO_NMH",s.default.log(e);try{this._port.postMessage(e)}catch(t){s.default.error("Send message to NMH fail ("+t.name+") : "+t.message),this.onMessage({tab_id:e.tab_id,id:e.id,cmd:"error",data:"Send message to NMH fail"})}}sendCleanMessageToNmh(e){var t;null===(t=this._port)||void 0===t||t.postMessage(e)}hasPort(){return!!this._port}disconnectFromNmh(){this._port&&(s.default.log("Native Messaging Host disconnect"),this._port.disconnect(),this._port=null)}_receiveMessageFromNmh(e,t){if(e.hasOwnProperty("parts")&&parseInt(e.parts,10)>1){this.queries.hasOwnProperty(e.parts_id)||(this.queries[e.parts_id]=[]);const t=e.parts_id;if(this.queries[t].push(e),this.queries[t].length===parseInt(e.parts,10)){const n={cmd:e.cmd,id:e.id,tab_id:e.tab_id,data:""};this.queries[t].forEach((e=>{n.data+=e.data})),this.onMessage(n),delete this.queries[t]}}else this.onMessage(e)}}},193:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(601),i=n(322);let r=0;const a=e=>{};t.default=class{constructor(){this.onQuery=a,this._ports=new Map,this._onPortMessage=this._onPortMessage.bind(this),chrome.runtime.onConnectExternal.addListener((e=>{this._registerPort(e)})),chrome.runtime.onMessageExternal.addListener(((e,t,n)=>{"checkBackground"===e&&n(!0)}))}broadcastMessage(e){this._ports.forEach((t=>{t.postMessage(e)}))}sendToAllTabs(e){const t=chrome.runtime.getManifest(),n=(null==t?void 0:t.content_scripts)&&(null==t?void 0:t.content_scripts[0].matches);chrome.tabs.query({url:n},(t=>{t.forEach((t=>{const n=t.id;n&&(e.type="FROM_BACKGROUND_SCRIPT_TO_CONTENT_SCRIPT",chrome.tabs.sendMessage(n,e))}))}))}sendMessage(e){const t=e.tab_id;e.type="FROM_BACKGROUND_SCRIPT_TO_CONTENT_SCRIPT",o.default.log(e);try{const n=this._ports.get(t);if(n)return n.postMessage(e),!0;o.default.log("received data from NMH is bad")}catch(e){o.default.error("Send message to content fail ("+e.name+") : "+e.message)}return!1}sendToTab(e,t){let n=!1;return this._ports.forEach((s=>{var o,i;(null===(i=null===(o=s.sender)||void 0===o?void 0:o.tab)||void 0===i?void 0:i.id)===t&&(n||(n=!0),s.postMessage(e))})),n}getWindowIdByPort(e){var t,n;return s(this,void 0,void 0,(function*(){const s=this._ports.get(e);return null===(n=null===(t=null==s?void 0:s.sender)||void 0===t?void 0:t.tab)||void 0===n?void 0:n.windowId}))}_registerPort(e){const t=r++;e.name=t.toString(),this._ports.set(t,e),e.onMessage.addListener(this._onPortMessage),e.onDisconnect.addListener((e=>{e.onMessage.removeListener(this._onPortMessage),this._unregisterPort(t),this.onQuery({tab_id:t,id:i.BROADCAST_TAB_ID,cmd:"disconnect",data:""})}))}_unregisterPort(e){this._ports.delete(e)}_onPortMessage(e,t){var n,s,o;e.tab_id=parseInt(t.name,10),e.origin=null===(n=t.sender)||void 0===n?void 0:n.origin,e.senderId=null===(o=null===(s=t.sender)||void 0===s?void 0:s.tab)||void 0===o?void 0:o.id,this.onQuery(e)}}},674:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=n(225),o=n(601),i=n(322),r="APP_CHECK_TIMEOUT",a="RESET_CHECK_TIMEOUT",c=e=>{};t.default=class{constructor(e){this.onConnect=c,this.onDisconnect=null,this._connectedApps=[],this._nmhPort=e,this._nmhPort.onDisconnect=()=>{this.onDisconnect&&this.onDisconnect()}}parsePingMessage(e){if(e.id!==i.APP_CONNECTION_ID);else{if("message"!==e.cmd&&chrome.alarms.create(r,{delayInMinutes:.08333333333333333}),"message"===e.cmd){const t=JSON.parse(e.data);if("event"===t.type&&"connected"===t.data.eventName){let t;switch(e.tab_id){case i.APP_ID.SabyAdmin:t=s.APP_LIST.SabyAdmin;break;case i.APP_ID.SabyPlugin:t=s.APP_LIST.SabyPlugin;break;case i.APP_ID.SabyScreen:t=s.APP_LIST.SabyScreen;break;case i.APP_ID.SabyCam:t=s.APP_LIST.SabyCam}t&&(this._connectedApps.push(t),o.default.log(`Connection to ${t} is established`))}}"disconnect"===e.cmd&&this.onDisconnect&&this.onDisconnect()}}connectApplications(e){return new Promise((t=>{e.forEach((e=>{this._nmhPort.connectToNmh((()=>{o.default.log(`Trying to establish a connection to ${e}`),this._nmhPort.sendMessageToNmh({cmd:"connect",data:`nng?appName=${e}`,id:i.APP_CONNECTION_ID,origin:"https://api.sbis.ru",tab_id:i.APP_ID[e],type:"FROM_CONTENT_SCRIPT_TO_BACKGROUND"})}))}));const n=()=>{chrome.alarms.clear(a),chrome.alarms.clear(r),chrome.alarms.onAlarm.removeListener(s),chrome.alarms.onAlarm.removeListener(c)},s=s=>{if(s.name===r){n();const s=[];e.forEach((e=>{s.push({appName:e,value:this._connectedApps.includes(e)})})),this._connectedApps=[],t(s)}};chrome.alarms.onAlarm.addListener(s);const c=e=>{e.name===a&&(n(),t([]))};chrome.alarms.onAlarm.addListener(c),chrome.alarms.create(a,{delayInMinutes:.5})}))}isPingMessage(e){return e.id===i.APP_CONNECTION_ID}}},427:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(e){this._timeout=null,this._nmhPort=e}createReconnectNmhTimeout(){var e;null!==(e=this._timeout)&&void 0!==e||(this._timeout=setTimeout((()=>{this._reconnect()}),2e4))}clearReconnectNmhTimeout(){this._timeout&&(clearTimeout(this._timeout),this._timeout=null)}_reconnect(){this._nmhPort.disconnectFromNmh(),this._nmhPort.connectToNmh(),this.clearReconnectNmhTimeout()}}},754:function(e,t,n){var s=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=n(549),i=n(322);t.default=class{constructor(e){this._connected=!1,this._nmhPort=e}sendData(e){return s(this,void 0,void 0,(function*(){try{this._connectDeferred||this.reconnect(),yield this._connectDeferred.promise,this._nmhPort.sendMessageToNmh({type:"FROM_WEB_PAGE_TO_CONTENT_SCRIPT",id:i.SERVICE_CONNECTION_ID,cmd:"message",data:e,tab_id:i.SERVICE_CONNECTION_ID,origin:"https://api.sbis.ru"})}catch(t){console.error(`Не могу отправить данные: ${e}`)}}))}parseMessage(e){try{if("message"===e.cmd){const t=JSON.parse(e.data);if("event"===t.type&&"connected"===t.data.eventName)return this._connectDeferred.resolve(),!0}return"error"===e.cmd?(this._connectDeferred.reject(),!0):"connect"===e.cmd}catch(e){return!1}}isServiceMessage(e){return e.tab_id===i.SERVICE_CONNECTION_ID}reconnect(){return s(this,void 0,void 0,(function*(){if(this._connectDeferred)try{yield this._connectDeferred.promise}catch(e){}this._connectDeferred=(0,o.default)(),this._connectDeferred.promise.catch((()=>{})),this._nmhPort.connectToNmh((()=>{this._nmhPort.sendMessageToNmh({cmd:"connect",data:"nng",id:i.SERVICE_CONNECTION_ID,origin:"https://api.sbis.ru",tab_id:i.SERVICE_CONNECTION_ID,type:"FROM_CONTENT_SCRIPT_TO_BACKGROUND"})}))}))}}},818:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0});const s=n(549);t.default=class{constructor(e){this._queries={},this._serviceConnection=e}parseMessage(e){try{if("message"===e.cmd){const t=JSON.parse(e.data);if(t.queryId in this._queries){let e;try{e=JSON.parse(t.data).result}catch(n){e=t.data}return"error"===t.type?this._queries[t.queryId].reject(e):this._queries[t.queryId].resolve(e),!0}}return!1}catch(e){return!1}}sendQuery(e){const t=e.queryId,n=(0,s.default)();return this._queries[t]=n,this._serviceConnection.sendData(JSON.stringify(e)),n.promise}}},949:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getLocalizedString=t.UI_LANG=void 0;const n={"СБИС Плагин":"Saby Plugin","Пожалуйста, нажмите на уведомление, чтобы запустить установку":"Please click on the notification to start the installation",Установить:"Install","Пожалуйста, запустите файл $filename$ в появившемся окне":"Please run the file $filename$ in the window that appears"};var s;!function(e){e.EN="en",e.RU="ru"}(s=t.UI_LANG||(t.UI_LANG={})),t.getLocalizedString=(e,t)=>{let o;return t===s.EN&&(o=n[e]),o||e}},549:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){let e,t;const n=new Promise(((n,s)=>{e=n,t=s}));return{resolve:e,reject:t,promise:n}}},601:function(e,t){var n=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const s="SbisPluginTransport:NMH:background:";function o(e){return"number"==typeof e?o(new Date(e)):`${e.getFullYear()}-${("0"+(e.getMonth()+1)).slice(-2)}-${("0"+e.getDate()).slice(-2)} ${("0"+e.getHours()).slice(-2)}:${("0"+e.getMinutes()).slice(-2)}:${("0"+e.getSeconds()).slice(-2)}`}t.default=new class{constructor(){this.debugMode=!1,this.logs=[],this.logsLoaded=new Promise((e=>{chrome.storage.local.get(["logs"],(t=>{t.hasOwnProperty("logs")?this.logs=t.logs:this.logs=[],e()}))}))}log(e){this.debugMode&&console.log(s+ +new Date,e)}error(e){this.debugMode&&console.error(s+ +new Date,e)}info(e){this.debugMode&&console.info(s+ +new Date,e)}logStore(e){const t=Date.now(),n=`${o(t)} ${t/1e3} ${"string"==typeof e?e:JSON.stringify(e)}`;this.debugMode&&console.log(s+n),this.logsLoaded.then((()=>{this.logs.push({time:t,message:n}),this._saveLogsToStorage()}))}deleteOldLogs(){return n(this,void 0,void 0,(function*(){const e=Date.now()-864e6;yield this.logsLoaded;const t=this.logs.length;this.logs=this.logs.filter((t=>t.time>e));const n=this.logs.length-t;n&&this.logStore({msg:`deleteOldLogs: удалено ${n} записей старше ${o(e)}, осталось ${this.logs.length}`})}))}_saveLogsToStorage(){this.logs&&(this.logs.splice(0,this.logs.length-1e3),chrome.storage.local.set({logs:this.logs}))}}}},t={};function n(s){var o=t[s];if(void 0!==o)return o.exports;var i=t[s]={exports:{}};return e[s].call(i.exports,i,i.exports,n),i.exports}(()=>{const e=n(481),t=n(439),s=n(193),o=n(377),i=n(715);n(753),(0,i.setApiObject)(chrome);const r=new s.default,a=new o.default,c=new t.default(!0);(0,e.start)(c,r,a),function(){const e=chrome.runtime.getManifest(),t=(null==e?void 0:e.content_scripts)&&e.content_scripts[0].js,n=(null==e?void 0:e.content_scripts)&&(null==e?void 0:e.content_scripts[0].matches);chrome.tabs.query({url:n},(e=>{e.forEach((e=>{chrome.scripting.executeScript({target:{tabId:e.id,allFrames:!0},files:t})}))}))}(),chrome.tabs.query({url:["*://chromewebstore.google.com/*/"+chrome.runtime.id+"*","*://addons.opera.com/*/sbis-plugin-extension*"]},(e=>{e.forEach((e=>{chrome.windows.get(e.windowId,{populate:!0},(t=>{var n;1===(null===(n=null==t?void 0:t.tabs)||void 0===n?void 0:n.length)&&chrome.windows.remove(e.windowId)}))}))}))})()})();