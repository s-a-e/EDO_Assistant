var uploadBtn=document.getElementById("uploadBtn"),downloadBtn=document.getElementById("downloadBtn"),sabyContainer=document.getElementById("sabyContainer"),foreignContainer=document.getElementById("foreignContainer"),errorContainer=document.getElementById("errorContainer"),startRecordBtn=document.getElementById("startRecordBtn"),stopRecordBtn=document.getElementById("stopRecordBtn"),fileContainer=document.getElementById("fileContainer"),incidentContainer=document.getElementById("incidentContainer"),filenameCaption=document.getElementById("filenameCaption"),incidentNumber=document.getElementById("incidentNumber"),progressContainer=document.getElementById("progressContainer"),progressCaption=document.getElementById("progressCaption"),state={fileName:"",uploadProgress:null,uploadNumber:null,isRecordActive:!1};async function init(){var[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),t=e.id,{tabs:n,domainsByHost:o}=await chrome.storage.local.get(["tabs","domainsByHost"]),a=new URL(e.url).host,i=!1;if(o)for([hostValue,domains]of Object.entries(o)){if(hostValue===a){i=!0;break}if(i=domains.indexOf(a)>-1)break}else o={};if(!i){var r=await getAllowedDomains(t);if(!r)return;i=!0,o[a]=r,await chrome.storage.local.set({domainsByHost:o})}if(i){setVisible(sabyContainer);var s=!(!n||!n[t]),d=await getHARForTab(e);d&&(state.fileName=d.fileName,state.uploadProgress=d.uploadProgress,state.uploadNumber=d.uploadNumber),state.isRecordActive=s,updateView(),startRecordBtn.addEventListener("click",toggleRecord),stopRecordBtn.addEventListener("click",toggleRecord),chrome.runtime.onMessage.addListener((e=>{"RECORD_CANCELED"==e.action&&(state={},updateView())})),downloadBtn.addEventListener("click",(async function(){var n=await getHARForTab(e),{fileName:o,fileContent:a}=n,i=getContentByChunks(encodeURIComponent(a));i.forEach(((e,n)=>{chrome.scripting.executeScript({target:{tabId:t},args:[e,n,i.length,o],function:downloadHARFileByChunks,world:"MAIN"})}))})),uploadBtn.addEventListener("click",(async function(){var t,n=await getHARForTab(e),{fileContent:o,fileName:a}=n,i=setInterval((async()=>{var t=await getHARForTab(e);t&&(state.uploadProgress=t.uploadProgress||0,updateView())}),1e3);state.uploadProgress=1,updateView();try{t=await uploadHARFile(e,o,a)}catch(e){t=null}clearInterval(i),state.uploadNumber=t,updateView(t?null:"Не удалось загрузить файл")}))}else setVisible(foreignContainer)}function updateView(e){var{uploadNumber:t,fileName:n,isRecordActive:o,uploadProgress:a}=state;if(o?(setHidden(startRecordBtn),setVisible(stopRecordBtn),uploadBtn.classList.replace("SabyExt-Button_shadow","SabyExt-Button__readOnly"),downloadBtn.classList.replace("SabyExt-Button_shadow","SabyExt-Button__readOnly")):(setHidden(stopRecordBtn),setVisible(startRecordBtn),uploadBtn.classList.replace("SabyExt-Button__readOnly","SabyExt-Button_shadow"),downloadBtn.classList.replace("SabyExt-Button__readOnly","SabyExt-Button_shadow")),e)return setHidden([fileContainer,incidentContainer,progressContainer]),setVisible(errorContainer),void(errorContainer.innerText=e);setHidden(errorContainer),o?(filenameCaption.innerText="",filenameCaption.title="",setHidden([fileContainer,incidentContainer,progressContainer])):t?(setHidden([fileContainer,progressContainer]),setVisible(incidentContainer),incidentNumber.innerText=t,incidentNumber.title=t,uploadBtn.classList.replace("SabyExt-Button_shadow","SabyExt-Button__readOnly")):a?(setHidden([fileContainer,incidentContainer]),setVisible(progressContainer),progressCaption.innerText=a):n&&(setVisible(fileContainer),setHidden([incidentContainer,progressContainer]),filenameCaption.innerText=n,filenameCaption.title=n)}async function toggleRecord(){var[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),t=await chrome.runtime.sendMessage({action:"TOGGLE_RECORD",tab:e});"RECORD_STARTED"===t.action?((state={}).isRecordActive=!0,updateView()):"RECORD_FINISHED"===t.action&&(state.fileName=t.data&&t.data.fileName,state.isRecordActive=!1,updateView())}async function downloadHARFileByChunks(e,t,n,o){var a=function(e,t,n,o){if(window[e]||(window[e]={count:0,arr:[]}),++window[e].count,window[e].arr[n]=t,window[e].count===o){var a=window[e].arr.join("");return delete window[e],a}return null}("SabyPlguinExtension_buffer_download_"+o,e,t,n);if(a){var i=document.createElement("a");i.setAttribute("href","data:application/json,"+a),i.setAttribute("download",o),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}function uploadHARFile(e,t,n){return new Promise((o=>{var a=getContentByChunks(t);a.forEach(((t,i)=>{chrome.scripting.executeScript({target:{tabId:e.id},args:[t,i,a.length,n,e,chrome.runtime.id],world:"MAIN",function:function(e,t,n,o,a,i){return new Promise((r=>{var s=function(e,t,n,o){if(window[e]||(window[e]={count:0,arr:[]}),++window[e].count,window[e].arr[n]=t,window[e].count===o){var a=window[e].arr.join("");return delete window[e],a}return null}("SabyPlguinExtension_buffer_upload_"+o,e,t,n);if(s){var d=new XMLHttpRequest;d.upload.onprogress=function(e){var t=parseInt(e.loaded/e.total*100);t>99&&(t=99),chrome.runtime.sendMessage(i,{action:"SET_UPLOAD_PROGRESS",tab:a,payload:{progress:t}})},d.upload.onerror=function(){r(null)},d.onload=function(){var e=parseInt(d.response,10);chrome.runtime.sendMessage(i,{action:"SET_UPLOAD_PROGRESS",tab:a,payload:{progress:100,uploadNumber:e}}),r(e)},d.open("POST","/logreceiver/service/upload_har/"),d.setRequestHeader("Content-Type","application/json"),d.send(s)}else r("SKIP_TOKEN")}))}},(function(e){var t=e&&e[0]&&e[0].result;if("SKIP_TOKEN"!==t)return t?"number"==typeof t?o(t):"error"in t?o(null):void 0:o(null)}))}))}))}function getAllowedDomains(e){return new Promise((t=>{chrome.scripting.executeScript({target:{tabId:e},function:async function(){return(await fetch("/auth/service/",{body:'{"jsonrpc":"2.0","protocol":6,"method":"ExternalClouds.GetInfo","params":{},"id":1}',method:"POST"})).json()}},(function(e){if(e&&e[0].result&&e[0].result.result){var n=e[0].result.result.allowedDomains;t(n)}else t(void 0)}))}))}async function getHARForTab(e){return(await chrome.runtime.sendMessage({action:"GET_HAR",tab:e})).data}function setVisible(e){e.classList.remove("isHidden")}function setHidden(e){e instanceof Array?e.forEach((e=>{e.classList.add("isHidden")})):e.classList.add("isHidden")}function getContentByChunks(e){var t=new Blob([e]),n=Math.ceil(t.size/3145728),o=Math.ceil(e.length/n),a=new Array(n),i=0;for(let t=0;t<n;++t)a[t]=e.substr(i,o),i+=o;return a}init();